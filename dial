#!/usr/bin/python
#+
# Simple script using my Asterisk Manager library to place a call.
#
# Created 2007 July 20 by Lawrence D'Oliveiro <ldo@geek-central.gen.nz>.
# Add timeout option 2008 July 31.
# Add --user and --password, no more default channel or context 2008 August 14.
#-

import sys
import getopt
import Asterisk

(Opts, Args) = getopt.getopt \
  (
    sys.argv[1:],
    "",
    ["channel=", "context=", "timeout=", "user=", "password="]
  )
Channel = None
Context = None
Timeout = 10 # default
User = None
Password = None
for Keyword, Value in Opts :
    if Keyword == "--channel" :
        Channel = Value
    elif Keyword == "--context" :
        Context = Value
    elif Keyword == "--password" :
        Password = Value
    elif Keyword == "--timeout" :
        Timeout = float(Value)
    elif Keyword == "--user" :
        User = Value
    #end if
#end for
if len(Args) != 1 :
    raise getopt.GetoptError("expecting one arg, the extension to dial")
#end if
if Context == None or Channel == None :
    raise getopt.GetoptError("--channel and --context are required")
#end if
if User == None or Password == None :
    raise getopt.GetoptError("--user and --password are required")
#end if
Extension = Args[0]

TheConn = Asterisk.Manager()
sys.stdout.write("TheConn opened, hello = \"%s\"\n" % TheConn.hello)
TheConn.Authenticate(User, Password)

Response = TheConn.Transact \
  (
    action = "Originate",
    parms =
        {
            "Channel" : Channel,
            "Context" : Context,
            "Exten" : Extension,
            "Priority" : 1,
            "Timeout" : int(round(Timeout * 1000)),
        }
  )
sys.stdout.write(repr(Response) + "\n")
TheConn.Transact("Logoff", {})
TheConn.close()
